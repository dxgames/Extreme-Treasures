<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üí∞ EXTREME TREASURES üí£</title>
    
    <meta property="og:title" content="Extreme Treasures">
    <meta property="og:description" content="¬°Atrapa tesoros, esquiva bombas y rompe tu propio r√©cord en este adictivo juego de reflejos!">
    <meta property="og:image" content="https://i.postimg.cc/CKPs2Xt0/previsualizacion.jpg">
    <meta property="og:url" content="TU_URL_DEL_JUEGO">
    
    <link rel="apple-touch-icon" href="https://i.postimg.cc/3NR5Tsrm/icono.png">
    <link rel="icon" href="https://i.postimg.cc/3NR5Tsrm/icono.png">
    
    <style>
        /* CSS B√°sico para el Juego de Navegador */
        body { 
            background-color: #4b371c; /* Color de fallback */
            margin: 0; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            font-family: 'Arial', sans-serif;
            color: white;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation; 
        }

        h1 {
            color: #ffcc00; 
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 5px; 
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
            display: none; 
        }

        canvas { 
            border: 5px solid #00ffff; 
            background-image: url('https://i.postimg.cc/Px2chqKH/Tablero.png'); 
            background-size: cover; 
            background-repeat: no-repeat;
            background-position: center;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            touch-action: none; 
            display: block; 
        }
        
        /* ESTILOS DEL MEN√ö Y AJUSTES */
        #menu-container, #settings-container, #music-select-container, #how-to-play-container, #about-container { 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 300px;
            max-height: 90vh; 
            overflow-y: auto; 
            z-index: 10;
        }

        .menu-button, .setting-button {
            background-color: #ffcc00;
            color: #000000;
            border: none;
            padding: 15px 30px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.2s, transform 0.1s;
        }

        .menu-button:hover, .setting-button:hover {
            background-color: #ffd700;
            transform: translateY(-2px);
        }
        
        .menu-button[disabled], .menu-button[disabled]:hover {
            background-color: #555 !important;
            color: #ccc !important;
            cursor: not-allowed !important;
            transform: none !important;
        }

        .setting-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 0;
            font-size: 1.1em;
            color: white;
        }
        
        .info-content p {
            text-align: left;
            margin: 5px 0;
            padding-left: 10px;
        }

        /* --- ESTILOS DEL BOT√ìN DE PAUSA --- */
        #controls-container {
            position: absolute;
            top: 25px;
            right: 25px;
            z-index: 5;
        }
        #pause-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 1.5em;
            cursor: pointer;
            transition: background-color 0.1s;
            line-height: 1; 
        }
        #pause-button:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body>

    <h1 id="game-title-text">EXTREME<br>TREASURES</h1>

    <div id="menu-container">
        <h2>Men√∫ Principal</h2>
        <button class="menu-button" onclick="showMusicSelectMenu()">Jugar</button> 
        <button class="menu-button" onclick="showSettings()">Ajustes</button>
        <button class="menu-button" onclick="showHowToPlayMenu()">Como se juega</button>
        <button class="menu-button" onclick="showAboutMenu()">Acerca del juego</button>
        <p id="high-score-display" style="margin-top: 15px; font-size: 1.1em; color: #ffcc00;"></p>
    </div>

    <div id="music-select-container" style="display: none;">
        <h2>Elige la M√∫sica</h2>
        <button class="menu-button" style="margin-top: 20px;" onclick="showMainMenu()">Volver</button>
    </div>

    <div id="settings-container" style="display: none;">
        <h2>Ajustes</h2>
        
        <div class="setting-label">
            <span>üîä Sonido</span>
            <button class="setting-button" id="sound-toggle" onclick="toggleSound()">
                Desactivar
            </button>
        </div>

        <div class="setting-label">
            <span>üì≥ Vibraci√≥n</span>
            <button class="setting-button" id="vibration-toggle" onclick="toggleVibration()">
                Desactivar
            </button>
        </div>

        <button class="menu-button" style="margin-top: 20px;" onclick="showMainMenu()">Volver</button>
    </div>
    
    <div id="how-to-play-container" style="display: none;">
        <h2>‚ùì ¬øC√≥mo se juega?</h2>
        <div class="info-content">
            <p>¬°Bienvenido a Extreme Treasures! El objetivo es recolectar las riquezas y aumentar tu puntuaci√≥n, mientras evitas las trampas.</p>
            <br>
            <h3>Items Comunes:</h3>
            <p>üíµ Billetes: Puntaje base (+20). Com√∫n.</p>
            <p>ü™ô Moneda de oro: Puntaje medio (+50). Raro.</p>
            <p>üíé Diamante: ¬°El tesoro m√°s valioso! (+1000). Muy raro.</p>
            <p>‚ù§Ô∏è Coraz√≥n: Restaura una vida (+1 HP).</p>
            <p>üí∏ Dinero con alas: Resta puntos (-20).</p>
            <p>üí£ Bombas: Peligro. Resta una vida (-1 HP). ¬°Vibra al tocarla!</p>
            <br>
            <h3>Potenciadores y Trampas:</h3>
            <p>‚≠ê Estrella (S√öPER FRENES√ç): Activa el modo Frenes√≠. La velocidad aumenta dr√°sticamente y solo aparecen items de valor durante 10 segundos.</p>
            <p>üëπ Diablo (TRAMPA DEMON√çACA): Activa el modo Trampa. La velocidad aumenta dr√°sticamente y solo aparecen bombas y dinero con alas durante 10 segundos.</p>
        </div>
        <button class="menu-button" style="margin-top: 20px;" onclick="showMainMenu()">Volver al men√∫</button>
    </div>

    <div id="about-container" style="display: none;">
        <h2>‚ú® Acerca del juego</h2>
        <div class="info-content">
            <p>Creado por DX GAMES</p>
            <p><strong>Versi√≥n: v1.3 (Plus)</strong></p>
            <br>
            <p style="text-align: center;">¬°Gracias por jugar!</p>
            </div>
        <button class="menu-button" style="margin-top: 20px;" onclick="showMainMenu()">Volver al men√∫</button>
    </div>

    <canvas id="gameCanvas" width="480" height="640" style="display: none;"></canvas>
    
    <div id="controls-container">
        <button id="pause-button" onclick="togglePause()" style="display: none;">‚è∏Ô∏è</button>
    </div>

    <audio id="bgm-player" loop preload="auto">
        Tu navegador no soporta el audio.
    </audio>

    <script>
        // --- 1. Inicializaci√≥n del Canvas y Contexto ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const BASE_WIDTH = 480;
        const BASE_HEIGHT = 640;

        function resizeCanvas() {
            const scale = Math.min(
                window.innerWidth / BASE_WIDTH,
                window.innerHeight / BASE_HEIGHT
            );

            canvas.style.width = BASE_WIDTH * scale + 'px';
            canvas.style.height = BASE_HEIGHT * scale + 'px';
        }

        window.addEventListener('resize', resizeCanvas);
        
        const menuContainer = document.getElementById('menu-container');
        const settingsContainer = document.getElementById('settings-container');
        const musicSelectContainer = document.getElementById('music-select-container');
        const howToPlayContainer = document.getElementById('how-to-play-container'); 
        const aboutContainer = document.getElementById('about-container'); 
        const pauseButton = document.getElementById('pause-button'); 
        const gameTitleText = document.getElementById('game-title-text'); 
        const highScoreDisplay = document.getElementById('high-score-display'); 

        const GAME_WIDTH = canvas.width;
        const GAME_HEIGHT = canvas.height;
        let canvasRect; 
        
        const bgmPlayer = document.getElementById('bgm-player');
        bgmPlayer.volume = 0.3; 
        
        // --- CONSTANTES DE FONDO EXTERNO ---
        const MENU_BG_IMAGE_URL = 'https://i.postimg.cc/hjpwgGMQ/Fondo_menuprincipal.png';
        const GAME_BG_IMAGE_URL = 'https://i.postimg.cc/TwCSGPQb/Fondo_juego.png';


        // --- INICIO: SECCI√ìN DE AJUSTES Y ESTADO GLOBAL ---
        let gameState = 'MENU'; 
        let audioStarted = false; 
        let highScore = 0; 
        
        // --- DATOS DE M√öSICA DE FONDO (Actualizaci√≥n 1.1) ---
        let currentBGMIndex = 0; 
        const BGM_OPTIONS = [
            // Nuevas canciones
            { name: "Pixel Polkka", url: "https://archive.org/download/ievan-polkka-8-bit-chiptune_202512/Ievan%20Polkka%208-Bit%20Chiptune.mp3", selectable: true },
            { name: "Pixel Apple", url: "https://archive.org/download/bad-apple-8-bit-tribute-to-nomico-8-bit-universe/Bad%20Apple%21%21%20%5B8%20Bit%20Tribute%20to%20Nomico%5D%20-%208%20Bit%20Universe.mp3", selectable: true },
            // Originales
            { name: "Nostalgia", url: "https://archive.org/download/TetrisThemeMusic/Tetris.mp3", selectable: true },
            { name: "Bot√≠n del Rescate", url: "https://archive.org/download/bella-ciao-8-bit-version/Bella%20Ciao-8%20Bit%20Version.mp3", selectable: true },
            { name: "Ritmo de la Fortuna", url: "https://archive.org/download/katyusha-8-bit_202512/Katyusha%20%288-bit%29.mp3", selectable: true },
            { name: "Ritmo de Asalto", url: "https://archive.org/download/german-military-march-erika-8-bit-cover/German%20Military%20March%20-%20Erika%208%20bit%20cover.mp3", selectable: true },
            // Modo sin m√∫sica
            { name: "Sin M√∫sica (üîá)", url: null, selectable: true },
            // No seleccionable
            { name: "¬°M√°s musica pr√≥ximamente!", url: null, selectable: false }
        ];
        
        // --- CONSTANTE DE VERSI√ìN ACTUALIZADA ---
        const GAME_VERSION = "v1.3 (Plus)"; 

        let settings = {
            sound: true,
            vibration: true
        };

        const soundToggleBtn = document.getElementById('sound-toggle');
        const vibrationToggleBtn = document.getElementById('vibration-toggle');

        function toggleSound() {
            settings.sound = !settings.sound;
            soundToggleBtn.textContent = settings.sound ? 'Desactivar' : 'Activar';

            if ((gameState === 'PLAYING' || gameState === 'PAUSED') && audioStarted) {
                if (settings.sound && gameState === 'PLAYING') {
                    playBGM();
                } else {
                    stopBGM();
                }
            }
        }

        // --- VIBRACI√ìN ---
        function vibrate(ms) {
            if (!settings.vibration) return;
            if (navigator.vibrate) {
                navigator.vibrate(ms);
            }
        }

        function toggleVibration() {
            settings.vibration = !settings.vibration;
            vibrationToggleBtn.textContent = settings.vibration ? 'Desactivar' : 'Activar';
            if (settings.vibration) {
                vibrate(100);
            }
        }
        
        // --- GESTI√ìN DE AUDIO (Efectos de sonido) ---
        const SOUNDS = {};
        
        const AUDIO_URLS = {
            coin: 'https://ejemplo.com/tu/ruta/coin.mp3', 
            life: 'https://ejemplo.com/tu/ruta/life.mp3',
            bomb: 'https://ejemplo.com/tu/ruta/bomb.mp3', 
            powerup: 'https://ejemplo.com/tu/ruta/powerup.mp3',
        };

        function loadAudio() {
            for (const key in AUDIO_URLS) {
                const audio = new Audio(AUDIO_URLS[key]);
                audio.volume = 0.5;
                SOUNDS[key] = audio;
            }
        }

        function playSound(key) {
            if (settings.sound) {
                const sound = SOUNDS[key];
                if (sound) {
                    const clone = sound.cloneNode();
                    clone.play().catch(e => {}); 
                }
            }
        }
        
        function playBGM() {
            if (settings.sound && BGM_OPTIONS[currentBGMIndex].url) {
                bgmPlayer.src = BGM_OPTIONS[currentBGMIndex].url; 
                bgmPlayer.currentTime = 0; 
                bgmPlayer.play().catch(e => {
                    console.log("Error al intentar reproducir BGM:", e);
                });
            } else {
                 stopBGM();
            }
        }
        
        function stopBGM() {
            bgmPlayer.pause();
            bgmPlayer.currentTime = 0;
        }
        
        loadAudio();
        // --- FIN: SECCI√ìN DE AJUSTES Y ESTADO GLOBAL ---

        // L√≥gica de R√©cords
        function loadHighScore() {
            const storedScore = localStorage.getItem('extremeTreasuresHighScore');
            highScore = storedScore ? parseInt(storedScore, 10) : 0;
            highScoreDisplay.textContent = `R√©cord: ${highScore}`;
        }

        function saveHighScore() {
            if (bag.score > highScore) {
                highScore = bag.score;
                localStorage.setItem('extremeTreasuresHighScore', highScore.toString());
            }
        }
        
        // --- FUNCI√ìN DE PAUSA ---
        function togglePause() {
            if (gameState === 'PLAYING') {
                gameState = 'PAUSED';
                stopBGM(); 
            } else if (gameState === 'PAUSED') {
                gameState = 'PLAYING';
                playBGM();
            }
        }

        // --- FUNCIONES DE VISTA Y FONDO ---
        function hideAllMenus() {
            menuContainer.style.display = 'none';
            settingsContainer.style.display = 'none';
            musicSelectContainer.style.display = 'none'; 
            howToPlayContainer.style.display = 'none';
            aboutContainer.style.display = 'none';
            canvas.style.display = 'none';
            pauseButton.style.display = 'none'; 
        }

        function setMenuBackground() {
            document.body.style.backgroundImage = `url('${MENU_BG_IMAGE_URL}')`;
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundAttachment = 'fixed';
            document.body.style.backgroundPosition = 'left center'; 
        }
        
        function setGameBackground() {
             document.body.style.backgroundImage = `url('${GAME_BG_IMAGE_URL}')`; 
             document.body.style.backgroundSize = 'cover';
             document.body.style.backgroundAttachment = 'fixed';
             document.body.style.backgroundPosition = 'center center';
        }

        function showMainMenu() {
            gameState = 'MENU';
            stopBGM(); 
            setMenuBackground(); 
            gameTitleText.style.display = 'block'; 
            
            hideAllMenus();
            menuContainer.style.display = 'flex';
            loadHighScore(); 
            
            const buttonsToRemove = musicSelectContainer.querySelectorAll('.menu-button:not([onclick="showMainMenu()"])');
            buttonsToRemove.forEach(btn => btn.remove());
        }

        function showSettings() {
            gameState = 'SETTINGS';
            setMenuBackground(); 
            gameTitleText.style.display = 'block'; 
            
            hideAllMenus();
            settingsContainer.style.display = 'flex';
            soundToggleBtn.textContent = settings.sound ? 'Desactivar' : 'Activar';
        }
        
        function showMusicSelectMenu() {
            gameState = 'MUSIC_SELECT';
            setMenuBackground(); 
            gameTitleText.style.display = 'block'; 
            
            hideAllMenus();
            musicSelectContainer.style.display = 'flex';

            const buttonsContainer = musicSelectContainer.querySelector('h2').nextElementSibling;
            if (buttonsContainer && buttonsContainer.tagName !== 'BUTTON') {
                buttonsContainer.remove(); 
            }

            const optionsHtml = BGM_OPTIONS.map((option, index) => {
                return `<button class="menu-button" 
                            ${option.selectable ? `onclick="playSelectedMusic(${index})"` : 'disabled'}
                            >
                            ${option.name} ${option.selectable ? '‚ñ∂Ô∏è' : ''}
                        </button>`;
            }).join('');
            
            musicSelectContainer.querySelector('h2').insertAdjacentHTML('afterend', `<div id="music-buttons-container">${optionsHtml}</div>`);
        }
        
        function showHowToPlayMenu() {
            gameState = 'INFO';
            setMenuBackground();
            gameTitleText.style.display = 'block';
            
            hideAllMenus();
            howToPlayContainer.style.display = 'flex';
        }

        function showAboutMenu() {
            gameState = 'INFO';
            setMenuBackground();
            gameTitleText.style.display = 'block';
            
            hideAllMenus();
            aboutContainer.style.display = 'flex';
        }

        function playSelectedMusic(index) {
            currentBGMIndex = index;
            startGameLogic(); 
        }


        function startGameLogic() {
            gameState = 'PLAYING';
            setGameBackground(); 
            gameTitleText.style.display = 'none'; 
            
            hideAllMenus();
            canvas.style.display = 'block';
            pauseButton.style.display = 'block';
            resetGame();
            audioStarted = false; 

            if (!gameLoopId) {
                gameLoopId = requestAnimationFrame(gameLoop);
            }
        }
        
        // --- 1.5. Carga de Imagen de la Bolsa (Player) ---
        let bagImage = new Image();
        const BAG_IMAGE_URL = 'https://i.postimg.cc/j5Z9KjvY/Bolsa.png';
        bagImage.src = BAG_IMAGE_URL; 

        bagImage.onload = () => { console.log("Imagen de la bolsa cargada."); };
        bagImage.onerror = () => { console.error("Error al cargar la imagen de la bolsa."); };

        // --- 2. Variables del Juego y la Bolsa (Player) ---
        const BAG_WIDTH = 60; 
        const BAG_HEIGHT = 60; 
        const BAG_SPEED = 7;   
        const MAX_LIFE = 5; 
        let bag = {
            x: (GAME_WIDTH / 2) - (BAG_WIDTH / 2),
            y: GAME_HEIGHT - BAG_HEIGHT - 20, 
            life: 3, 
            score: 0 
        };

        // --- 3. Variables de Dificultad, Nivel y MODOS ---
        let currentLevel = 1; 
        const LEVEL_UP_SCORE = 1000; 
        const BASE_SPEED = 2; 
        const SPEED_INCREASE_RATE = 0.05; 
        
        let items = []; 
        const ITEM_SIZE = 40; 
        let itemSpawnRate = 100; 
        let itemSpawnCounter = 0; 

        // --- VARIABLES DE FRENES√ç Y TRAMPA ---
        let isFrenzyActive = false;
        let isTrapActive = false; 
        let modeEndTime = 0;
        const MODE_DURATION = 10000; 
        const MODE_SPEED_BOOST = 3.0; 

        // --- 4. Tipos de Objetos y sus propiedades ---
        const ITEM_TYPES = {
            MONEY_NOTE: { emoji: 'üíµ', value: 20, type: 'good', weight: 8 },
            GOLD_COIN: { emoji: 'ü™ô', value: 50, type: 'good', weight: 4 },
            DIAMOND: { emoji: 'üíé', value: 1000, type: 'good', weight: 0.5 }, 
            HEART: { emoji: '‚ù§Ô∏è', value: 1, type: 'bonus', weight: 1 },
            POWERUP_FRENZY: { emoji: '‚≠ê', value: 0, type: 'powerup', weight: 0.2 }, 
            TRAP_DEMON: { emoji: 'üëπ', value: 0, type: 'trap', weight: 0.1 }, 
            MONEY_WINGS: { emoji: 'üí∏', value: -20, type: 'bad', weight: 3 }, 
            BOMB: { emoji: 'üí£', value: -1, type: 'life_bad', weight: 3 } 
        };
        const totalWeight = Object.values(ITEM_TYPES).reduce((sum, type) => sum + type.weight, 0);

        // --- 5. Variables de Entrada y Estado ---
        let rightPressed = false;
        let leftPressed = false;
        let bagMoveTargetX = null; // Mantenemos la variable pero ya no la usamos para target
        let gameLoopId;


        // --- 6. Funciones de Dibujo ---
        function drawBackground() {
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT); 
        }
        
        function drawBag() {
            ctx.save();
            ctx.globalAlpha = 1.0; 
            if (bagImage.complete && bagImage.naturalWidth !== 0) {
                ctx.drawImage(bagImage, bag.x, bag.y, BAG_WIDTH, BAG_HEIGHT);
            } else {
                ctx.font = `${BAG_WIDTH}px Arial`; 
                ctx.textAlign = 'center';
                ctx.fillText('üí∞', bag.x + BAG_WIDTH / 2, bag.y + BAG_HEIGHT - 5);
            }
            ctx.restore(); 
        }

        function drawItems() {
            ctx.save(); 
            ctx.globalAlpha = 1.0; 
            ctx.shadowColor = 'black'; 
            ctx.shadowBlur = 5;
            ctx.fillStyle = 'white'; 

            items.forEach(item => {
                const itemX = item.x;
                const itemY = item.y;
                
                ctx.font = `${ITEM_SIZE}px Arial`; 
                ctx.textAlign = 'center';
                ctx.fillText(item.type.emoji, itemX + ITEM_SIZE / 2, itemY + ITEM_SIZE - 5);
            });
            
            ctx.restore(); 
        }

        function drawLifeBar() {
            const barX = GAME_WIDTH - 160;
            const barY = 15;
            const barW = 150;
            const barH = 20;
            
            ctx.fillStyle = '#444'; ctx.fillRect(barX, barY, barW, barH);
            const lifeRatio = bag.life / MAX_LIFE;
            const currentLifeW = barW * lifeRatio;
            
            ctx.fillStyle = (bag.life <= 1) ? '#ff0000' : '#00cc00'; 
            ctx.fillRect(barX, barY, currentLifeW, barH);
            ctx.strokeStyle = 'white'; ctx.strokeRect(barX, barY, barW, barH);

            ctx.fillStyle = 'white';
            ctx.font = '18px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`Nivel: ${currentLevel}`, 10, 30); 
            ctx.fillText(`Puntos: ${bag.score}`, 10, 60); 
            ctx.fillText(`R√©cord: ${highScore}`, 10, 90); 
            ctx.fillText(`HP: ${bag.life}/${MAX_LIFE}`, barX + barW + 10, barY + 16);
            
            if (isFrenzyActive) {
                const timeRemaining = Math.ceil((modeEndTime - Date.now()) / 1000);
                ctx.fillStyle = '#ff9900'; 
                ctx.font = '22px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`¬°S√öPER FRENES√ç! ‚ö° ${timeRemaining}s`, GAME_WIDTH / 2, 45); 
            } else if (isTrapActive) {
                const timeRemaining = Math.ceil((modeEndTime - Date.now()) / 1000);
                ctx.fillStyle = '#ff0000'; 
                ctx.font = '22px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`¬°TRAMPA DEMON√çACA! üëπ ${timeRemaining}s`, GAME_WIDTH / 2, 45);
            }
        }

        function drawHUD() {
            drawLifeBar();

            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.font = '14px Arial';
            ctx.textAlign = 'right';
            ctx.fillText(`Versi√≥n: ${GAME_VERSION}`, GAME_WIDTH - 10, GAME_HEIGHT - 10); 

            if (gameState === 'PAUSED') {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                ctx.fillStyle = '#ffcc00';
                ctx.font = '50px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('PAUSA', GAME_WIDTH / 2, GAME_HEIGHT / 2 - 20);
                ctx.font = '24px Arial';
                ctx.fillText('Toca o pulsa ESPACIO/P para reanudar', GAME_WIDTH / 2, GAME_HEIGHT / 2 + 30);
            }

            if (gameState === 'GAMEOVER') {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                saveHighScore(); 
                
                ctx.fillStyle = 'white';
                ctx.font = '40px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('¬°Juego Terminado!', GAME_WIDTH / 2, GAME_HEIGHT / 2 - 80);
                
                ctx.font = '24px Arial';
                ctx.fillText(`Puntuaci√≥n Final: ${bag.score}`, GAME_WIDTH / 2, GAME_HEIGHT / 2 - 20);
                ctx.fillStyle = '#ffcc00';
                ctx.fillText(`R√©cord Guardado: ${highScore}`, GAME_WIDTH / 2, GAME_HEIGHT / 2 + 20);
                
                ctx.fillStyle = 'white';
                ctx.fillText('Toca o pulsa R para volver al men√∫', GAME_WIDTH / 2, GAME_HEIGHT / 2 + 70);
            }
        }

        // --- 7. L√≥gica de Dificultad y Colisi√≥n ---
        function calculateSpeed() {
            const speedMultiplier = 1 + (currentLevel - 1) * SPEED_INCREASE_RATE;
            let finalMultiplier = speedMultiplier;
            if (isFrenzyActive || isTrapActive) {
                finalMultiplier *= MODE_SPEED_BOOST; 
            }
            const minSpeed = BASE_SPEED * finalMultiplier;
            const maxSpeed = (BASE_SPEED + 2) * finalMultiplier; 
            return { minSpeed, maxSpeed };
        }

        function updateDifficulty() {
            const newLevel = Math.floor(bag.score / LEVEL_UP_SCORE) + 1;
            if (newLevel > currentLevel) {
                currentLevel = newLevel;
                itemSpawnRate = Math.max(10, itemSpawnRate - 5);
            }
        }
        
        function checkCollision(objA, objB) {
            return objA.x < objB.x + ITEM_SIZE &&
                objA.x + BAG_WIDTH > objB.x &&
                bag.y < objB.y + ITEM_SIZE &&
                bag.y + BAG_HEIGHT > objB.y;
        }


        // --- 8. L√≥gica Principal de Actualizaci√≥n ---

        function spawnItem() {
            let typeToSpawn;
            if (isFrenzyActive) {
                const frenzyWeights = { GOLD_COIN: 5, DIAMOND: 50, MONEY_NOTE: 5, HEART: 1 };
                const frenzyTotalWeight = Object.values(frenzyWeights).reduce((sum, weight) => sum + weight, 0);
                let randomNum = Math.random() * frenzyTotalWeight;
                for (const key in frenzyWeights) {
                    randomNum -= frenzyWeights[key];
                    if (randomNum <= 0) { typeToSpawn = ITEM_TYPES[key]; break; }
                }
            } else if (isTrapActive) {
                const trapWeights = { BOMB: 10, MONEY_WINGS: 5 };
                const trapTotalWeight = Object.values(trapWeights).reduce((sum, weight) => sum + weight, 0);
                let randomNum = Math.random() * trapTotalWeight;
                for (const key in trapWeights) {
                    randomNum -= trapWeights[key];
                    if (randomNum <= 0) { typeToSpawn = ITEM_TYPES[key]; break; }
                }
            } else {
                let randomNum = Math.random() * totalWeight;
                for (const key in ITEM_TYPES) {
                    randomNum -= ITEM_TYPES[key].weight;
                    if (randomNum <= 0) { typeToSpawn = ITEM_TYPES[key]; break; }
                }
            }
            if (!typeToSpawn) return; 

            const x = Math.random() * (GAME_WIDTH - ITEM_SIZE);
            const { minSpeed, maxSpeed } = calculateSpeed();
            const speed = minSpeed + (Math.random() * (maxSpeed - minSpeed));

            items.push({ x: x, y: -ITEM_SIZE, speed: speed, type: typeToSpawn });
        }

        function update() {
            if (gameState !== 'PLAYING') return; 

            if (isFrenzyActive || isTrapActive) {
                if (Date.now() > modeEndTime) {
                    isFrenzyActive = false;
                    isTrapActive = false;
                    modeEndTime = 0;
                }
            }

            // --- MOVIMIENTO DE LA BOLSA (FIXED PLUS) ---
            if (rightPressed) { bag.x += BAG_SPEED; } 
            else if (leftPressed) { bag.x -= BAG_SPEED; }
            
            // Eliminado el c√≥digo de "persecuci√≥n" (bagMoveTargetX)
            // para usar movimiento directo en los eventos t√°ctiles.

            bag.x = Math.max(0, Math.min(bag.x, GAME_WIDTH - BAG_WIDTH));
            bag.life = Math.min(bag.life, MAX_LIFE);

            // Generar nuevos objetos
            itemSpawnCounter++;
            const currentSpawnRate = (isFrenzyActive || isTrapActive) ? 30 : itemSpawnRate; 

            if (itemSpawnCounter >= currentSpawnRate) {
                spawnItem();
                itemSpawnCounter = 0;
            }

            // Mover objetos y detectar colisiones
            for (let i = items.length - 1; i >= 0; i--) {
                let item = items[i];
                item.y += item.speed;

                if (checkCollision(bag, item)) {
                    if (item.type.type === 'powerup') {
                        isFrenzyActive = true;
                        isTrapActive = false;
                        modeEndTime = Date.now() + MODE_DURATION;
                        playSound('powerup');
                    }
                    else if (item.type.type === 'trap') {
                        isTrapActive = true;
                        isFrenzyActive = false; 
                        modeEndTime = Date.now() + MODE_DURATION;
                        playSound('bomb'); 
                        vibrate(400); 
                    }
                    else if (item.type.type === 'good' || item.type.type === 'bad') {
                        bag.score += item.type.value;
                        updateDifficulty();
                        playSound('coin'); 
                    } 
                    else if (item.type.type === 'bonus') {
                        bag.life += item.type.value; 
                        playSound('life'); 
                    }
                    else if (item.type.type === 'life_bad') {
                        bag.life += item.type.value; 
                        playSound('bomb');
                        vibrate(200);
                    }
                    
                    bag.score = Math.max(0, bag.score); 
                    items.splice(i, 1); 
                } 
                else if (item.y > GAME_HEIGHT) {
                    items.splice(i, 1); 
                }
            }

            if (bag.life <= 0) {
                bag.life = 0; 
                gameState = 'GAMEOVER';
                stopBGM(); 
            }
        }

        function resetGame() {
            bag.x = (GAME_WIDTH / 2) - (BAG_WIDTH / 2);
            bag.life = 3;
            bag.score = 0;
            items = [];
            currentLevel = 1; 
            itemSpawnRate = 100;
            itemSpawnCounter = 0;
            
            isFrenzyActive = false; 
            isTrapActive = false;
            modeEndTime = 0;
            
            audioStarted = false;
            loadHighScore(); 
        }

        // --- 9. Manejo de Entrada (Teclado y T√°ctil) ---

        document.addEventListener('keydown', (e) => {
            if (gameState === 'PLAYING' || gameState === 'PAUSED') {
                if (e.key === ' ' || e.key.toLowerCase() === 'p') {
                    e.preventDefault(); 
                    togglePause();
                    return;
                }
            }
            if (gameState === 'GAMEOVER' && e.key.toLowerCase() === 'r') {
                showMainMenu();
                return;
            }
            if (gameState === 'PLAYING') {
                if (!audioStarted) {
                    playBGM();
                    audioStarted = true;
                }
                if (e.key === 'Right' || e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') {
                    rightPressed = true;
                } else if (e.key === 'Left' || e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') {
                    leftPressed = true;
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (gameState === 'PLAYING') {
                if (e.key === 'Right' || e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') {
                    rightPressed = false;
                } else if (e.key === 'Left' || e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') {
                    leftPressed = false;
                }
            }
        });

        // --- FUNCIONES T√ÅCTILES MEJORADAS (PLUS FIX) ---
        function getTouchX(e) {
            // Recalculamos el rect√°ngulo por si hubo scroll o cambio de tama√±o
            canvasRect = canvas.getBoundingClientRect(); 
            // Factor de escala: Relaci√≥n entre resoluci√≥n interna (480) y tama√±o en pantalla
            const scaleX = canvas.width / canvasRect.width;
            // Obtenemos la posici√≥n X relativa al canvas y aplicamos la escala
            return (e.touches[0].clientX - canvasRect.left) * scaleX;
        }

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            
            if (gameState === 'GAMEOVER') {
                showMainMenu();
                return;
            }
            if (gameState === 'PAUSED') { 
                togglePause();
                return;
            }
            if (gameState === 'PLAYING') {
                if (!audioStarted) {
                    playBGM();
                    audioStarted = true;
                }
                // MOVIMIENTO INSTANT√ÅNEO
                const touchX = getTouchX(e);
                bag.x = touchX - (BAG_WIDTH / 2);
                bag.x = Math.max(0, Math.min(bag.x, GAME_WIDTH - BAG_WIDTH));
                
                bagMoveTargetX = null; 
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (gameState === 'PLAYING') {
                // SEGUIMIENTO 1:1
                const touchX = getTouchX(e);
                bag.x = touchX - (BAG_WIDTH / 2);
                bag.x = Math.max(0, Math.min(bag.x, GAME_WIDTH - BAG_WIDTH));
            }
        });

        canvas.addEventListener('touchend', () => {
            bagMoveTargetX = null; 
        });


        // --- 10. Bucle Principal y Inicializaci√≥n ---

        function gameLoop() {
            if (gameState !== 'MENU' && gameState !== 'SETTINGS' && gameState !== 'MUSIC_SELECT' && gameState !== 'INFO') { 
                drawBackground(); 
                if (gameState === 'PLAYING') {
                    update();
                }
                drawBag();
                drawItems();
                drawHUD();
            }
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function initGame() {
            if (!canvas || !ctx) return; 
            canvasRect = canvas.getBoundingClientRect(); 
            resizeCanvas();
            loadHighScore(); 
            showMainMenu();
            if (!gameLoopId) {
                gameLoopId = requestAnimationFrame(gameLoop);
            }
        }

        document.addEventListener('DOMContentLoaded', initGame); 

        window.addEventListener('resize', () => {
            if (canvas) {
                canvasRect = canvas.getBoundingClientRect();
            }
        });
    </script>
</body>
</html>